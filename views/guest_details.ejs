<html> <!--apply required on all fields-->
    <head>
        <title>Details</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel='stylesheet' href="/css/style1.css">
        <link rel='stylesheet' href="/css/style7.css">

        <link rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
            integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA=="
            crossorigin="anonymous" referrerpolicy="no-referrer" />
    </head>
    <body id='content'>

        <div id='container'>

            <%- include('partials/navbar') %>
            <style>
                .selected-room {
                    border: 1px solid #ccc;
                    padding: 20px;
                    margin: 20px 0;
                    border-radius: 10px;
                    background-color: #f9f9f9;
                    display: flex;
                    align-items: center;
                }
                .selected-room h2 {
                    margin-bottom: 15px;
                }
                .selected-room img.room-image {
                    max-width: 12%;
                    height: auto;
                    border-radius: 10px;
                    margin-right: 20px;
                }
                .selected-room .room-details {
                    flex: 1;
                }
                .selected-room p {
                    margin: 5px 0;
                }
            </style>

            <div class="selected-room">
                <img src="<%= room.image %>" alt="Room Image"
                    class="room-image">
                <div class="room-details">
                    <h2>Selected Room Details</h2>
                    <p><strong>Room Type:</strong> <%= room.category %></p>
                    <p><strong>Price:</strong> Rs. <%= room.price %> per night</p>
                    <p><strong>Description:</strong> <%= room.description %></p>
                </div>
            </div>

            <div class='form'>
                <p class='heading'>Guest Details</p>
                <form id='form'>
                    <div class='box'>
                        <p>Guest Details</p>
                        <div class='flex'>
                            <div class='input-control'>
                                <input type="text" placeholder="First Name"
                                    id='first-name' required>
                                <div class='error-box'></div>
                            </div>
                            <div class='input-control'>
                                <input type="text" placeholder="Last Name"
                                    id='last-name' required>
                                <div class='error-box'></div>
                            </div>
                        </div>
                        <div class='flex'>
                            <div class='input-control'>
                                <input type="text" placeholder="Mobile"
                                    id='mobile' required>
                                <div class='error-box'></div>
                            </div>
                            <div class='input-control'>
                                <input type="email" placeholder="Email Address"
                                    id='email' required>
                                <div class='error-box'></div>
                                <p class='mail-detail'>This is the email we will
                                    send your confirmation to.</p>
                            </div>
                        </div>
                        <p>Address</p>
                        <div class='input-control'>
                            <input type="text" placeholder="Country"
                                id='country' required>
                            <div class='error-box'></div>
                        </div>
                        <div class='input-control'>
                            <input type="text" placeholder="Address 1"
                                id='address' required>
                            <div class='error-box'></div>
                        </div>
                        <div class='input-control'>
                            <input type="text" placeholder="Postal / Zip Code"
                                id='zip-code' required>
                            <div class='error-box'></div>
                        </div>
                        <hr>
                        <p>Payment </p>
                        <div class='payment'>
                            <!-- <div class='button'>
                                <button type="button" id="payButton"
                                    class="active">Pay Now</button>
                                <button type='button' id='key2' class='inactive'
                                    onclick='key_function()'>Pay at
                                    Hotel</button>
                            </div> -->
                            <div class="button">
                                <button type="button" id="payButton" class="inactive">Pay Now</button>
                                <button type="button" id="key2" class="inactive">Pay at Hotel</button>
                              </div>
                            <p id='para1'>Please provide a valid payment
                                method.</p>
                            <p id='para2'>Payment information is only needed to
                                guarantee your reservation. Full amount billed
                                during the stay will be charged at the property.
                                As per Reserve Bank of India guidelines on data
                                protection, we are unable to store our guests'
                                card details. In order to process your booking,
                                we need to validate your card online. You will
                                soon receive details of tokenising your card on
                                the registered email id.</p>
                            <img src='/images/payment.jpg'>
                        </div>
                    </div>
                    <div class='policy'>
                        <p>Policies:</p>
                        <h3>Check-in
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Check-out</h3>
                        <p class='time'>After 2:00 PM
                            &nbsp;&nbsp;&nbsp;&nbsp;Before 12:00 PM</p>
                        <p>
                            Guarantee Policy<br>
                            Your credit card will be charged with the final bill
                            amount at the hotel. In case of late cancellation or
                            No Show, hotel is authorised to charge the
                            applicable cancellation charge, including any taxes
                            and fees on the credit card used to guarantee the
                            stay.
                        </p>
                        <p>
                            Cancel Policy<br>
                            Guaranteed reservations may be cancelled 30 days
                            prior to date of arrival without any cancellation
                            charge. Cancellations received less than 30 days
                            prior to arrival will incur 100% cancellation charge
                            of the entire stay including applicable taxes and
                            fees.
                        </p>
                    </div>
                    <div class='akg'>
                        <p>Acknowledgement</p>
                        <p>By completing this booking, I agree with the Booking
                            Conditions.</p>
                        <input type='checkbox' class='check' id='mark'><span
                            class='agree'>* I agree with the Privacy
                            Policy.</span>
                        <div id='error'></div>
                    </div>
                    <div class='final'>
                        <input type='submit' value='Complete Booking'
                            class='submit'>
                        <div class="nav-links"></div>
                        <a href="https://test.instamojo.com/@hs7570377/"
                            rel="im-checkout" data-text="Pay"
                            data-css-style="color:#ffffff; background:#75c26a; width:180px; border-radius:4px"></a>
                    </div>
                </form>   
            </div>
           <script>
               document.addEventListener("DOMContentLoaded", function () {
  // Payment selection logic
  const payNowBtn = document.getElementById("payButton");
  const payAtHotelBtn = document.getElementById("key2");
  let selectedPaymentMethod = null;

  function updatePaymentButtons(activeButton, inactiveButton) {
    activeButton.classList.add("active");
    activeButton.classList.remove("inactive");
    inactiveButton.classList.add("inactive");
    inactiveButton.classList.remove("active");
  }

  payNowBtn.addEventListener("click", function () {
    selectedPaymentMethod = { mode: "Pay Now", status: "Completed" };
    updatePaymentButtons(payNowBtn, payAtHotelBtn);
  });

  payAtHotelBtn.addEventListener("click", function () {
    selectedPaymentMethod = { mode: "Pay at Hotel", status: "Pending" };
    updatePaymentButtons(payAtHotelBtn, payNowBtn);
  });

  // Form submission handler
  document.getElementById('form').addEventListener('submit', async function (e) {
    e.preventDefault();

    // Validate that all required fields exist in the DOM
    const requiredFields = ['first-name', 'last-name', 'mobile', 'email', 'country', 'address', 'zip-code'];
    const missingFields = requiredFields.filter(id => !document.getElementById(id));
    if (missingFields.length > 0) {
      alert("Some required fields are missing: " + missingFields.join(', '));
      return;
    }

    // Validate that a payment method is selected
    if (!selectedPaymentMethod) {
      alert("Please select a payment method before proceeding.");
      return;
    }

    // Retrieve guest details from the form
    const guestDetails = {
      firstName: document.getElementById('first-name').value.trim(),
      lastName: document.getElementById('last-name').value.trim(),
      mobile: document.getElementById('mobile').value.trim(),
      email: document.getElementById('email').value.trim(),
      country: document.getElementById('country').value.trim(),
      address: document.getElementById('address').value.trim(),
      zipCode: document.getElementById('zip-code').value.trim(),
      // Try to get room id from a hidden input, otherwise fallback to server rendered value
      room: document.getElementById('room-id')?.value || '<%= room._id %>',
      agreePrivacyPolicy: document.getElementById('mark')?.checked || false,
      payment: selectedPaymentMethod // Include payment details
    };

    // Retrieve any existing booking data from sessionStorage
    let existingBookingData = {};
    try {
      const storedData = sessionStorage.getItem('bookingData');
      if (storedData) {
        existingBookingData = JSON.parse(storedData);
      }
    } catch (error) {
      console.error("Error parsing bookingData:", error);
    }

    // Merge existing booking data with the new guest details
    const combinedData = { ...existingBookingData, ...guestDetails };
    sessionStorage.setItem('bookingData', JSON.stringify(combinedData));

    // Send combined data to the backend
    try {
      const response = await fetch(`/api/booking`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': localStorage.getItem('token')
        },
        body: JSON.stringify(combinedData)
      });
      if (!response.ok) throw new Error('Failed to save guest details.');
      alert('Booking Successful');
      // Wait for 3 seconds before redirecting to the home page
      sessionStorage.removeItem('bookingData');
      window.location.href = '/confirmation_page?';
    } catch (error) {
      console.error('Error saving guest details:', error);
      alert("There was an error saving your details. Please try again.");
    }
  });
});


            </script>                  
            </div>
        </div>
        <%- include('partials/footer') %>
        <script src="/js/navbar.js"></script>
        <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
        <script>
    const roomPrice = <%= room.price %>;
    const apiKey = '<%= apiKey %>';
    document.getElementById("payButton").addEventListener("click", async () => {
        try {
                const response = await fetch("http://localhost:8080/create-razorpay-order", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ amount:roomPrice}) // Fixed
                });
   
        const data = await response.json();
        var options = {
            "key":apiKey , // Replace with your Razorpay Key ID
            "amount":data.amount , // Amount in paise (₹500 = 50000 paise)
            "currency": "INR",
            "name": "Test Payment",
            "description": "Testing Razorpay Payment",
            "image": "https://yourlogo.com/logo.png", // Optional logo
            "handler": function (response) {
                alert("Payment Successful!\nPayment ID: " + response.razorpay_payment_id);
            },
            "prefill": {
                "name": "John Doe",
                "email": "johndoe@example.com",
                "contact": "9876543210"
            },
            "theme": { "color": "#3399cc" }
        };

        var rzp = new Razorpay(options);
        rzp.open();
    } catch (error) {
                console.error("Error:", error);
            }
    });
</script>

    </body>
    <script type='text/javascript' src="/js/script_hotel.js"></script>
    <script type='text/javascript' src="/js/script_guest.js"></script>

</html>